<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WeedGuard Prediction</title>
</head>
<body>
    <h1>Upload or Take a Picture for Weed Detection</h1>

    <!-- Form for Uploading or Taking a Picture -->
    <form id="uploadForm" enctype="multipart/form-data" method="post" action="{% url 'predict' %}">
        {% csrf_token %}
        
        <!-- Dropdown to choose source -->
        <label for="image-source">Select Source:</label>
        <select id="image-source">
            <option value="upload">Upload from Computer</option>
            <option value="camera">Take a Picture</option>
        </select><br><br>
        
        <!-- File input for uploading an image -->
        <label for="image">Image:</label>
        <input type="file" id="image" name="image" accept="image/*" required>
        
        <!-- Camera view and capture button -->
        <div id="camera-input" style="display: none;">
            <video id="camera-view" autoplay></video>
            <button type="button" id="capture-btn">Capture</button>
            <canvas id="camera-canvas" style="display: none;"></canvas>
        </div>

        <!-- Additional Information -->
        <label for="location">GPS Location:</label>
        <input type="text" id="location" name="location" placeholder="Enter GPS coordinates"><br><br>

        <label for="site_name">Site Name:</label>
        <input type="text" id="site_name" name="site_name" placeholder="Enter site name"><br><br>

        <label for="farmer">Farmer Name:</label>
        <input type="text" id="farmer" name="farmer" placeholder="Enter farmer's name"><br><br>

        <!-- Submit Button -->
        <button type="submit">Predict</button>
    </form>

    <div id="result"></div>

    <!-- JavaScript -->
    <script>
        const imageSource = document.getElementById('image-source');
        const imageInput = document.getElementById('image');
        const cameraInput = document.getElementById('camera-input');
        const cameraView = document.getElementById('camera-view');
        const cameraCanvas = document.getElementById('camera-canvas');
        const captureBtn = document.getElementById('capture-btn');
        const form = document.getElementById('uploadForm');
        const resultDiv = document.getElementById('result');

        // Toggle between upload and camera mode
        imageSource.addEventListener('change', (e) => {
            const selected = e.target.value;
            if (selected === 'camera') {
                cameraInput.style.display = 'block';
                imageInput.style.display = 'none';
                startCamera();
            } else {
                cameraInput.style.display = 'none';
                imageInput.style.display = 'block';
                stopCamera();
            }
        });

        // Start the camera
        async function startCamera() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                cameraView.srcObject = stream;
            } catch (error) {
                console.error("Camera access denied:", error);
                alert("Unable to access camera. Please allow camera access.");
            }
        }

        // Stop the camera
        function stopCamera() {
            const stream = cameraView.srcObject;
            if (stream) {
                const tracks = stream.getTracks();
                tracks.forEach(track => track.stop());
            }
            cameraView.srcObject = null;
        }

        // Capture the image from the camera
        captureBtn.addEventListener('click', () => {
            const context = cameraCanvas.getContext('2d');
            cameraCanvas.width = cameraView.videoWidth;
            cameraCanvas.height = cameraView.videoHeight;
            context.drawImage(cameraView, 0, 0, cameraCanvas.width, cameraCanvas.height);

            // Convert canvas to blob and set as file input
            cameraCanvas.toBlob((blob) => {
                const file = new File([blob], "captured_image.png", { type: "image/png" });
                const dataTransfer = new DataTransfer();
                dataTransfer.items.add(file);
                imageInput.files = dataTransfer.files; // Assign the captured image as the input file
            });
        });

        // Submit the form and show results
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(form);

            // Send the form data
            const response = await fetch(form.action, {
                method: 'POST',
                body: formData,
            });
            const data = await response.json();
            if (data.error) {
                resultDiv.innerHTML = `<p style="color: red;">Error: ${data.error}</p>`;
            } else {
                resultDiv.innerHTML = `<h3>${data.prediction}</h3>`;
            }
        });
    </script>
</body>
</html>
